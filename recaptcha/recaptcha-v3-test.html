<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reCAPTCHA v3 í…ŒìŠ¤íŠ¸</title>
    <!-- reCAPTCHA v3ëŠ” ì‚¬ì´íŠ¸í‚¤ë¥¼ URLì— ì§ì ‘ í¬í•¨í•´ì•¼ í•¨ -->
    <script id="recaptcha-script"></script>
</head>
<body>
<h1>reCAPTCHA v3 í…ŒìŠ¤íŠ¸</h1>

<h2>ì„¤ì •</h2>
<div>
    <label>API ì„œë²„ URL:</label><br>
    <input type="text" id="apiUrl" value="http://localhost:8080" style="width: 300px;"><br><br>

    <label>reCAPTCHA Site Key:</label><br>
    <input type="text" id="siteKey" placeholder="Site Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 500px;"><br><br>

    <button onclick="updateSiteKey()">Site Key ì ìš©</button>
</div>

<hr>

<h2>reCAPTCHA v3 ê²€ì¦</h2>
<div>
    <label>ìµœì†Œ ì ìˆ˜ (0.0 ~ 1.0):</label><br>
    <input type="number" id="minScore" min="0" max="1" step="0.1" value="0.5"><br><br>

    <label>Action:</label><br>
    <input type="text" id="action" value="test" placeholder="ì˜ˆ: login, register, test"><br><br>

    <button onclick="testV3()" id="testV3Btn">v3 ê²€ì¦ í…ŒìŠ¤íŠ¸</button>
</div>

<h3>ê²°ê³¼:</h3>
<pre id="result" style="background: #f0f0f0; padding: 10px; border: 1px solid #ccc;"></pre>

<hr>

<div>
    <a href="recaptcha-v2-test.html">v2 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™</a> |
    <a href="recaptcha-status-test.html">ì„œë²„ ìƒíƒœ í™•ì¸ í˜ì´ì§€</a>
</div>

<script>
    let siteKey = '';
    let recaptchaReady = false;

    function updateSiteKey() {
        siteKey = document.getElementById('siteKey').value.trim();
        if (!siteKey) {
            alert('Site Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
        const existingScript = document.getElementById('recaptcha-script');
        if (existingScript && existingScript.src) {
            existingScript.remove();
        }

        // v3ìš© ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
        const script = document.createElement('script');
        script.id = 'recaptcha-script';
        script.src = `https://www.google.com/recaptcha/api.js?render=${siteKey}`;
        script.async = true;
        script.defer = true;

        script.onload = function() {
            console.log('reCAPTCHA v3 ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
            initRecaptchaV3();
        };

        script.onerror = function() {
            document.getElementById('result').textContent = 'âŒ reCAPTCHA ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨. Site Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        };

        document.head.appendChild(script);
        document.getElementById('result').textContent = 'reCAPTCHA v3 ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì¤‘...';
    }

    function initRecaptchaV3() {
        if (!siteKey) {
            return;
        }

        if (typeof grecaptcha !== 'undefined') {
            grecaptcha.ready(function() {
                console.log('reCAPTCHA v3 ì¤€ë¹„ ì™„ë£Œ');
                recaptchaReady = true;
                document.getElementById('testV3Btn').disabled = false;
                document.getElementById('result').textContent = `âœ… reCAPTCHA v3 ì¤€ë¹„ ì™„ë£Œ\nSite Key: ${siteKey}`;
            });
        }
    }

    async function testV3() {
        if (!siteKey) {
            alert('ë¨¼ì € Site Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!recaptchaReady) {
            alert('reCAPTCHAê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        const action = document.getElementById('action').value || 'test';

        try {
            document.getElementById('result').textContent = 'reCAPTCHA v3 í† í° ìƒì„± ì¤‘...';

            const token = await grecaptcha.execute(siteKey, { action: action });

            document.getElementById('result').textContent = 'API ì„œë²„ë¡œ ê²€ì¦ ìš”ì²­ ì¤‘...';

            const minScore = parseFloat(document.getElementById('minScore').value);
            const apiUrl = document.getElementById('apiUrl').value;

            const result = await fetch(`${apiUrl}/open/recaptcha/v3/verify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: token,
                    minScore: minScore
                })
            });

            const data = await result.json();

            if (result.ok) {
                document.getElementById('result').textContent = `âœ… ì„±ê³µ!\n${JSON.stringify(data, null, 2)}`;
            } else {
                document.getElementById('result').textContent = `âŒ ì‹¤íŒ¨!\n${JSON.stringify(data, null, 2)}`;
            }
        } catch (error) {
            document.getElementById('result').textContent = `ğŸš¨ ì˜¤ë¥˜: ${error.message}`;
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì„¤ì •
    window.onload = function() {
        // í…ŒìŠ¤íŠ¸ í‚¤ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        document.getElementById('siteKey').value = '6LfKURIUAAAAAO50vlwOf5gjTTiByOm_yhKpd3bh';
        document.getElementById('result').textContent = 'ìœ„ì˜ Site Keyë¥¼ ì ìš©í•˜ë ¤ë©´ "Site Key ì ìš©" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.';
    };
</script>

<!-- v3ëŠ” ë”ë¯¸ ì»¨í…Œì´ë„ˆê°€ í•„ìš” ì—†ìŒ -->
</body>
</html>